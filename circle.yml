machine:
  services:
    - docker

test:
  pre:
    - bin/covalence prereqs:api:apply
  override:
    # Verify
    - bin/covalence ci
    # UAT
    - bin/covalence proxy:http:apply
    - bin/covalence stage:domain:apply
    - bin/covalence stage:deploy:apply
    - bin/covalence usage:defaults:apply
    # Clean up
    - bin/covalence usage:defaults:destroy
    ## Race conditions prevent a clean destroy on the stage
    - bin/covalence stage:deploy:destroy || true
    - bin/covalence stage:deploy:destroy
    - bin/covalence proxy:destroy
